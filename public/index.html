<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mafia for Monke üêµ</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .role-mafia { color: #ef4444; }
    .role-sheriff { color: #3b82f6; }
    .role-doctor { color: #10b981; }
    .role-mayor { color: #8b5cf6; }
    .role-jester { color: #eab308; }
    .role-civilian { color: #6b7280; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const App = () => {
      const [gameState, setGameState] = useState('lobby');
      const [players, setPlayers] = useState([]);
      const [currentPhase, setCurrentPhase] = useState('');
      const [gameLog, setGameLog] = useState(['Welcome to Mafia for Monke!']);
      const [nightResults, setNightResults] = useState([]);
      const [localPlayer, setLocalPlayer] = useState(null);
      const [playerName, setPlayerName] = useState('');
      const [gameId, setGameId] = useState('');
      const [showGame, setShowGame] = useState(false);
      const [votes, setVotes] = useState({});
      const socketRef = useRef(null);

      // Generate a random game ID
      useEffect(() => {
        setGameId(Math.random().toString(36).substr(2, 6).toUpperCase());
      }, []);

      // Setup Socket.IO connection
      useEffect(() => {
        const socket = io();
        socketRef.current = socket;
        
        // Listen for game updates
        socket.on('gameUpdate', (game) => {
          console.log('Received game update:', game);
          setGameState(game.gameState);
          setPlayers(game.players || []);
          setCurrentPhase(game.currentPhase);
          setGameLog(game.gameLog || ['Welcome to Mafia for Monke!']);
          setNightResults(game.nightResults || []);
          
          // Find local player
          const local = game.players?.find(p => p.socketId === socket.id);
          if (local) {
            setLocalPlayer(local);
          }
        });

        // Listen for role updates
        socket.on('roleUpdate', (roleData) => {
          console.log('Received role update:', roleData);
          setLocalPlayer(prev => ({
            ...prev,
            role: roleData.role,
            isMayor: roleData.isMayor
          }));
        });

        // Clean up on unmount
        return () => {
          if (socketRef.current) {
            socketRef.current.disconnect();
          }
        };
      }, []);

      const joinGame = () => {
        if (!playerName.trim()) {
          alert('Please enter your name');
          return;
        }
        
        const socket = socketRef.current;
        const gameIdToUse = gameId.trim() || Math.random().toString(36).substr(2, 6).toUpperCase();
        
        socket.emit('joinGame', { 
          gameId: gameIdToUse, 
          playerName: playerName.trim()
        });
        
        setGameId(gameIdToUse);
        setShowGame(true);
      };

      const startGame = () => {
        const socket = socketRef.current;
        socket.emit('startGame', gameId);
      };

      const handleMafiaAction = (targetId) => {
        const socket = socketRef.current;
        socket.emit('mafiaAction', { gameId, targetId });
      };

      const handleSheriffAction = (targetId, shoot = false) => {
        const socket = socketRef.current;
        socket.emit('sheriffAction', { gameId, targetId, shoot });
      };

      const handleDoctorAction = (targetId) => {
        const socket = socketRef.current;
        socket.emit('doctorAction', { gameId, targetId });
      };

      const handleVote = (targetId) => {
        const socket = socketRef.current;
        socket.emit('vote', { 
          gameId, 
          voterId: socket.id,
          targetId 
        });
      };

      const skipToVoting = () => {
        const socket = socketRef.current;
        socket.emit('skipToVoting', gameId);
      };

      const skipVoting = () => {
        const socket = socketRef.current;
        socket.emit('skipVoting', gameId);
      };

      const processNight = () => {
        const socket = socketRef.current;
        socket.emit('processNight', gameId);
      };

      const getAlivePlayers = () => players.filter(p => p.alive);
      const getRoleColor = (role) => {
        switch (role) {
          case 'Mafia': return 'text-red-500';
          case 'Sheriff': return 'text-blue-500';
          case 'Doctor': return 'text-green-500';
          case 'Mayor': return 'text-purple-500';
          case 'Jester': return 'text-yellow-500';
          default: return 'text-gray-500';
        }
      };

      if (!showGame) {
        return (
          <div className="container mx-auto px-4 py-8">
            <div className="text-center mb-8">
              <h1 className="text-5xl font-bold mb-4 bg-gradient-to-r from-red-400 to-purple-500 bg-clip-text text-transparent">
                Mafia for Monke üêµ
              </h1>
              <p className="text-xl text-gray-300">A social deduction game of deception and strategy</p>
            </div>

            <div className="max-w-md mx-auto bg-black bg-opacity-30 rounded-xl p-8 backdrop-blur-sm">
              <h2 className="text-3xl font-bold mb-6 text-center">Join Game</h2>
              
              <div className="space-y-6">
                <div>
                  <label className="block text-sm font-medium mb-2">Your Name</label>
                  <input 
                    type="text" 
                    value={playerName}
                    onChange={(e) => setPlayerName(e.target.value)}
                    placeholder="Enter your name"
                    className="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 focus:border-purple-500 focus:outline-none"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-2">Game ID</label>
                  <div className="flex">
                    <input 
                      type="text" 
                      value={gameId}
                      onChange={(e) => setGameId(e.target.value)}
                      placeholder="Game ID (or use generated one)"
                      className="flex-1 p-3 rounded-l-lg bg-gray-800 border border-gray-600 focus:border-purple-500 focus:outline-none"
                    />
                    <button 
                      onClick={() => setGameId(Math.random().toString(36).substr(2, 6).toUpperCase())}
                      className="bg-gray-700 hover:bg-gray-600 px-4 rounded-r-lg"
                    >
                      Generate
                    </button>
                  </div>
                </div>
                
                <button 
                  onClick={joinGame}
                  className="w-full bg-gradient-to-r from-red-500 to-purple-600 hover:from-red-600 hover:to-purple-700 px-8 py-4 rounded-lg text-xl font-bold transition-all duration-200 transform hover:scale-105"
                >
                  Join Game
                </button>
              </div>

              <div className="mt-6 text-center text-sm text-gray-400">
                <p>Share the Game ID with your friends to play together!</p>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="container mx-auto px-4 py-8">
          {/* Header */}
          <div className="text-center mb-8">
            <h1 className="text-5xl font-bold mb-4 bg-gradient-to-r from-red-400 to-purple-500 bg-clip-text text-transparent">
              Mafia for Monke üêµ
            </h1>
            <p className="text-xl text-gray-300">Game ID: <strong>{gameId}</strong></p>
          </div>

          {/* Game Status */}
          <div className="bg-black bg-opacity-30 rounded-xl p-6 mb-6 backdrop-blur-sm">
            <div className="flex flex-col sm:flex-row justify-between items-center mb-4">
              <div>
                <h2 className="text-2xl font-semibold">
                  {gameState === 'gameOver' ? 'Game Over' : 
                   gameState === 'lobby' ? 'Lobby' :
                   currentPhase === 'mafia' ? 'Mafia Phase' :
                   currentPhase === 'sheriff' ? 'Sheriff Phase' :
                   currentPhase === 'doctor' ? 'Doctor Phase' :
                   currentPhase === 'voting' ? 'Voting Phase' : 'Night Phase'}
                </h2>
                {localPlayer && (
                  <p className="text-gray-300">
                    You are: <span className={getRoleColor(localPlayer.role)}>{localPlayer.role}</span>
                    {localPlayer.isMayor && " (Mayor)"}
                  </p>
                )}
              </div>
              <div className="text-right">
                <p className="text-lg">Alive: {getAlivePlayers().length}/8</p>
              </div>
            </div>

            {gameState === 'lobby' && players.length >= 5 && (
              <div className="text-center">
                <p className="mb-4">Players in game: {players.length}</p>
                <button
                  onClick={startGame}
                  className="bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 px-8 py-3 rounded-lg font-semibold transition-all duration-200"
                >
                  Start Game
                </button>
              </div>
            )}
            
            {gameState === 'lobby' && players.length < 5 && players.length > 1 && (
              <div className="text-center">
                <p className="text-yellow-400">Need at least 5 players to start (2 Mafias, 1 Sheriff, 1 Doctor, 1 Mayor)</p>
              </div>
            )}
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Player List */}
            <div className="lg:col-span-1">
              <div className="bg-black bg-opacity-30 rounded-xl p-6 backdrop-blur-sm">
                <h3 className="text-xl font-semibold mb-4">Players</h3>
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {players.map(player => (
                    <div
                      key={player.id}
                      className={`p-3 rounded-lg transition-all duration-200 ${
                        player.alive 
                          ? 'bg-gray-800 bg-opacity-50' 
                          : 'bg-gray-800 bg-opacity-30 line-through opacity-60'
                      }`}
                    >
                      <div className="flex justify-between items-center">
                        <div>
                          <p className="font-medium">{player.name}</p>
                        </div>
                        <div className="text-right">
                          {player.alive ? (
                            <span className="text-green-400 text-sm">‚úì Alive</span>
                          ) : (
                            <span className="text-red-400 text-sm">‚úó Dead</span>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Game Area */}
            <div className="lg:col-span-2">
              {/* Night Phase Actions */}
              {gameState === 'night' && currentPhase !== 'results' && (
                <div className="bg-black bg-opacity-30 rounded-xl p-6 backdrop-blur-sm mb-6">
                  <h3 className="text-xl font-semibold mb-4">Night Actions</h3>
                  
                  {currentPhase === 'mafia' && localPlayer?.role === 'Mafia' && localPlayer.alive && (
                    <div>
                      <p className="mb-4 text-yellow-300">Both Mafias must agree on the same target to eliminate:</p>
                      <div className="grid grid-cols-2 gap-2">
                        {getAlivePlayers().filter(p => p.role !== 'Mafia').map(player => (
                          <button
                            key={player.id}
                            onClick={() => handleMafiaAction(player.id)}
                            className="bg-red-600 hover:bg-red-700 p-3 rounded-lg transition-colors"
                          >
                            {player.name}
                          </button>
                        ))}
                      </div>
                    </div>
                  )}

                  {currentPhase === 'sheriff' && localPlayer?.role === 'Sheriff' && localPlayer.alive && (
                    <div>
                      <p className="mb-4 text-blue-300">Choose a player to investigate or shoot:</p>
                      <div className="grid grid-cols-2 gap-2 mb-4">
                        {getAlivePlayers().filter(p => p.id !== localPlayer.id).map(player => (
                          <button
                            key={player.id}
                            onClick={() => handleSheriffAction(player.id)}
                            className="bg-blue-600 hover:bg-blue-700 p-3 rounded-lg transition-colors"
                          >
                            Investigate {player.name}
                          </button>
                        ))}
                      </div>
                      <div className="text-center">
                        <button
                          onClick={() => handleSheriffAction(localPlayer.id, true)}
                          className="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold"
                        >
                          Shoot Selected Player
                        </button>
                      </div>
                    </div>
                  )}

                  {currentPhase === 'doctor' && localPlayer?.role === 'Doctor' && localPlayer.alive && (
                    <div>
                      <p className="mb-4 text-green-300">Choose a player to heal (can save from mafia or sheriff):</p>
                      <div className="grid grid-cols-2 gap-2">
                        {getAlivePlayers().map(player => (
                          <button
                            key={player.id}
                            onClick={() => handleDoctorAction(player.id)}
                            className="bg-green-600 hover:bg-green-700 p-3 rounded-lg transition-colors"
                          >
                            Heal {player.name}
                          </button>
                        ))}
                      </div>
                    </div>
                  )}

                  <div className="mt-4 text-center">
                    <button
                      onClick={skipToVoting}
                      className="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold transition-all duration-200"
                    >
                      Skip to Voting
                    </button>
                  </div>
                </div>
              )}

              {/* Results Phase - Only show before voting */}
              {gameState === 'night' && currentPhase === 'results' && (
                <div className="bg-black bg-opacity-30 rounded-xl p-6 backdrop-blur-sm mb-6">
                  <h3 className="text-xl font-semibold mb-4">Night Results</h3>
                  <div className="space-y-2 mb-4">
                    {nightResults.length > 0 ? (
                      nightResults.map((result, index) => (
                        <div key={index} className="text-yellow-300 p-2 bg-gray-800 bg-opacity-50 rounded">
                          {result}
                        </div>
                      ))
                    ) : (
                      <p className="text-yellow-300">No night actions were performed.</p>
                    )}
                  </div>
                  <button
                    onClick={processNight}
                    className="bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 px-8 py-3 rounded-lg font-semibold transition-all duration-200"
                  >
                    Start Voting
                  </button>
                </div>
              )}

              {/* Voting Phase */}
              {currentPhase === 'voting' && (
                <div className="bg-black bg-opacity-30 rounded-xl p-6 backdrop-blur-sm mb-6">
                  <h3 className="text-xl font-semibold mb-4">Voting Phase</h3>
                  <p className="mb-4 text-purple-300">
                    Vote for the player you believe is the mafia. Mayor's vote counts as 2!
                  </p>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    {getAlivePlayers().map(player => (
                      <button
                        key={player.id}
                        onClick={() => handleVote(player.id)}
                        disabled={votes[localPlayer?.id] !== undefined}
                        className={`p-4 rounded-lg transition-all duration-200 ${
                          votes[localPlayer?.id] === player.id
                            ? 'bg-purple-600 ring-2 ring-purple-400'
                            : 'bg-gray-700 hover:bg-gray-600'
                        } ${player.id === localPlayer?.id ? 'opacity-50 cursor-not-allowed' : ''}`}
                      >
                        <div className="font-medium">{player.name}</div>
                        {votes[localPlayer?.id] === player.id && (
                          <div className="text-yellow-400 mt-1">‚úì Voted</div>
                        )}
                      </button>
                    ))}
                  </div>
                  
                  <div className="mt-6 text-center">
                    <button
                      onClick={skipVoting}
                      className="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold transition-all duration-200"
                    >
                      Skip Voting
                    </button>
                  </div>
                </div>
              )}

              {/* Game Log */}
              <div className="bg-black bg-opacity-30 rounded-xl p-6 backdrop-blur-sm">
                <h3 className="text-xl font-semibold mb-4">Game Log</h3>
                <div className="max-h-64 overflow-y-auto space-y-2">
                  {gameLog.map((log, index) => (
                    <div key={index} className="text-sm bg-gray-800 bg-opacity-50 p-2 rounded text-gray-300">
                      {log}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>

          {/* Instructions */}
          <div className="mt-8 bg-black bg-opacity-30 rounded-xl p-6 backdrop-blur-sm">
            <h3 className="text-xl font-semibold mb-4">How to Play</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h4 className="font-semibold text-blue-400 mb-2">Roles:</h4>
                <ul className="text-sm space-y-1 text-gray-300">
                  <li>‚Ä¢ <span className="text-red-400">Mafia</span> (x2): Both must agree on the same target to kill</li>
                  <li>‚Ä¢ <span className="text-blue-400">Sheriff</span>: Investigate or shoot players (shoots self if wrong)</li>
                  <li>‚Ä¢ <span className="text-green-400">Doctor</span>: Heal one player each night</li>
                  <li>‚Ä¢ <span className="text-purple-400">Mayor</span>: Vote counts as 2 (role hidden)</li>
                  <li>‚Ä¢ <span className="text-yellow-400">Jester</span>: Win by being voted out</li>
                  <li>‚Ä¢ <span className="text-gray-400">Civilian</span>: Find and eliminate the mafia</li>
                </ul>
              </div>
              <div>
                <h4 className="font-semibold text-green-400 mb-2">Rules:</h4>
                <ul className="text-sm space-y-1 text-gray-300">
                  <li>‚Ä¢ Need at least 5 players to start</li>
                  <li>‚Ä¢ Night: Mafias agree, Sheriff investigates/shoots, Doctor heals</li>
                  <li>‚Ä¢ Day: Discussion and voting phase</li>
                  <li>‚Ä¢ Mayor's vote counts as 2 votes</li>
                  <li>‚Ä¢ Civilians win when all mafia are eliminated</li>
                  <li>‚Ä¢ Mafia win when they equal or outnumber innocents</li>
                  <li>‚Ä¢ Sheriff dies if they shoot an innocent civilian</li>
                  <li>‚Ä¢ Use Skip buttons to advance phases if needed</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>